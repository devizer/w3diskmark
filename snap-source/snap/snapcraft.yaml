name: w3diskmark
base: core20
version: 'vFake'
summary: Cross-Platform Disk Benchmark
grade: devel
confinement: devmode
description: |
  w3diskmark is backed by fio, provides rich Material based UI using built-in http server, supports wide range of browsers and linux distributions.

parts:
  w3diskmark:
    override-pull: |
      set -eux
      echo "BEFORE: "$(ls "$SNAPCRAFT_PART_SRC")
      script=https://raw.githubusercontent.com/devizer/test-and-build/master/install-build-tools-bundle.sh; (wget -q -nv --no-check-certificate -O - $script 2>/dev/null || curl -ksSL $script) | bash
      arch="$SNAPCRAFT_TARGET_ARCH";
      if [[ "$arch" == "amd64" ]]; then arch=x64; elif [[ "$arch" == "armhf" ]]; then arch=arm; fi
      url="https://github.com/devizer/w3top-bin/releases/latest/download/w3top-linux-$arch.tar.xz"
      echo "Downloading [$url] for the [$SNAPCRAFT_TARGET_ARCH] arch"
      try-and-retry curl -ksfSL -o /tmp/w3diskmark-$arch.tar.xz "$url"
      pushd "$SNAPCRAFT_PART_SRC"
        tar xJf /tmp/w3diskmark-$arch.tar.xz
        rm -f /tmp/w3diskmark-$arch.tar.xz
      popd
      # SKIP: snapcraftctl pull
      echo "AFTER: "$(ls "$SNAPCRAFT_PART_SRC")
      ver="$(cat VERSION)"
      echo "VERSION IS [$ver] (2.41+)"
      snapcraftctl set-version "$ver"
      echo "KERNEL IS $(uname -r)"
      printenv | sort | grep "SNAP\|SNAPCRAFT" || true
    plugin: dump
    source: # pull ignored
      - to amd64: ./bin-x64/
      - to arm64: ./bin-arm64/
      - to armhf: ./bin-arm/
    stage-packages:
      - ca-certificates
      # - libicu60
      # - libssl1.1
      - liblttng-ust0
      # - fio

      # curl ca-certificates libkrb5-3 zlib1g libicu60 libssl1.0.0 libssl1.1 libunwind8 libuuid1 liblttng-ust0

apps:
  service:
    command: ./w3diskmark
    daemon: simple
    install-mode: enable
    refresh-mode: restart
    restart-condition: on-failure
    restart-delay: 10s
    plugs: 
      - network
      - network-bind

